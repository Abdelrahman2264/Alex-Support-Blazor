@page "/Sites/Create"
@page "/Sites/Update/{id:int}"
@inject ILocationRepository _ISite
@inject NavigationManager _navigationManager
@inject IJSRuntime JS
@using AlexSupport.ViewModels;
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
<PageTitle>@(Sites.LID == 0 ? "Create Site" : "Update Site")</PageTitle>

@if (isProcessing)
{
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75 z-index-1050">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Processing...</p>
    </div>
}
else
{
    <div class="container-fluid px-4 py-3">
        <div class="card border-0 shadow-lg rounded-3 overflow-hidden">
            <div class="card-header bg-primary-gradient py-4">
                <div class="row align-items-center">
                    <div class="col-12 text-center">
                        <h2 class="text-white mb-0">
                            <i class="bi bi-geo-alt me-2"></i>@(Sites.LID == 0 ? "Create Site Location" : "Update Site Location")
                        </h2>
                    </div>
                </div>
            </div>

            <div class="card-body p-4">
                <EditForm Model="Sites" FormName="SiteUpsertForm" OnValidSubmit="UpsertSite">
                    <DataAnnotationsValidator></DataAnnotationsValidator>

                    @if (exist && isSiteExist)
                    {
                        <div class="alert alert-danger mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@SiteExistErrorMessage
                        </div>
                    }

                    <div class="mb-4">
                        <div class="form-floating">
                            <InputText @bind-Value="Sites.LocationName" class="form-control border-2 shadow-sm" id="Name" />
                            <label for="Name">Site Name</label>
                            <ValidationMessage For="@(()=>Sites.LocationName)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-3 pt-3">
                        <a href="/Sites" class="btn btn-outline-secondary rounded-pill px-4">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                        <button type="submit" class="btn btn-primary rounded-pill px-4" disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi @(Sites.LID == 0 ? "bi-plus-circle" : "bi-save") me-2"></i>
                            }
                            @(Sites.LID == 0 ? "Create" : "Update")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<style>
    .bg-primary-gradient {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    }

    .z-index-1050 {
        z-index: 1050;
    }

    .rounded-3 {
        border-radius: 0.75rem !important;
    }

    .rounded-pill {
        border-radius: 50rem !important;
    }

    .form-control {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

        .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    .alert {
        border-radius: 0.5rem;
    }
</style>

@code {
    [Parameter]
    public int Id { get; set; }
    [SupplyParameterFromForm]
    private Location Sites { get; set; } = new Location();
    private bool isProcessing { get; set; } = false;

    private string SiteExistErrorMessage { get; set; } = string.Empty;
    private bool isSiteExist { get; set; } = false;
    private bool exist { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        isProcessing = true;
        await LoadType();
        isProcessing = false;
        StateHasChanged();
    }

    private async Task LoadType()
    {
        if (Id > 0)
        {
            Sites = await _ISite.GetLocationAsync(Id);
        }
    }

    private async Task UpsertSite()
    {
        SiteExistErrorMessage = string.Empty;
        isSiteExist = false;
        exist = false;
        bool flag = false;

        isSiteExist = await _ISite.CheckIfSiteNameExist(Sites.LocationName, Sites.LID);
        if (isSiteExist)
        {
            SiteExistErrorMessage = "This site already exists!";
            isProcessing = false;
            exist = true;
            return;
        }

        isProcessing = true;

        if (Sites.LID == 0)
        {
            await _ISite.CreateLocationAsync(Sites);
            JS?.ToastrSuccess("Site location created successfully");
            flag = true;
        }
        else
        {
            await _ISite.UpdateLocationAsync(Sites);
            JS?.ToastrSuccess("Site location updated successfully");
            flag = true;
        }

        isProcessing = false;

        if (flag)
        {
            _navigationManager.NavigateTo("Sites");
        }
        else
        {
            JS?.ToastrError("Something went wrong. Please try again!");
        }
    }
}