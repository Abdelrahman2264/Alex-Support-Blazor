@page "/Categories/Create"
@page "/Categories/Update/{id:int}"
@inject ICategoryRepository _ICategory
@inject NavigationManager _navigationManager
@inject IJSRuntime JS
@inject ILogService LogService
@rendermode InteractiveServer
@attribute [Authorize(Roles ="Admin")]
<PageTitle>@(Types.CID == 0 ? "Create Category Type" : "Update Category Type")</PageTitle>

@if (isProcessing)
{
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75 z-index-1050">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Processing...</p>
    </div>
}
else
{
    <div class="container-fluid px-4 py-3">
        <div class="card border-0 shadow-lg rounded-3 overflow-hidden">
            <div class="card-header bg-primary-gradient py-4">
                <div class="row align-items-center">
                    <div class="col-12 text-center">
                        <h2 class="text-white mb-0">
                            <i class="bi bi-tag me-2"></i>@(Types.CID == 0 ? "Create Category Type" : "Update Category Type")
                        </h2>
                    </div>
                </div>
            </div>

            <div class="card-body p-4">
                <EditForm Model="Types" FormName="TypeUpsertForm" OnValidSubmit="UpsertType">
                    <DataAnnotationsValidator></DataAnnotationsValidator>

                    @if (isTypeExist)
                    {
                        <div class="alert alert-danger mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TypeExistErrorMessage
                        </div>
                    }

                    <div class="mb-4">
                        <div class="form-floating">
                            <InputText @bind-Value="Types.CategoryName" class="form-control border-2 shadow-sm" id="Name" />
                            <label for="Name">Category Name</label>
                            <ValidationMessage For="@(()=>Types.CategoryName)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-3 pt-3">
                        <a href="/Categories" class="btn btn-outline-secondary rounded-pill px-4">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                        <button type="submit" class="btn btn-primary rounded-pill px-4" disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi @(Types.CID == 0 ? "bi-plus-circle" : "bi-save") me-2"></i>
                            }
                            @(Types.CID == 0 ? "Create" : "Update")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<style>

    :root {
        --primary-color: blue;
     
    }
    .bg-primary-gradient {
        background: linear-gradient(135deg, var(--primary-color) 0%, white 100%);
    }

    .z-index-1050 {
    z-index: 1050;
    }

    .rounded-3 {
    border-radius: 0.75rem !important;
    }

    .rounded-pill {
    border-radius: 50rem !important;
    }

    .form-control {
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
@code {
    [Parameter]
    public int Id { get; set; } = 0;
    [SupplyParameterFromForm]
    private Category Types { get; set; } = new Category();
    private bool isProcessing { get; set; } = false;


    private string TypeExistErrorMessage { get; set; } = string.Empty;
    private bool isTypeExist { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(TimeSpan.FromSeconds(0.1));
        await LoadType();
        isProcessing = false;
        StateHasChanged();
    }

    private async Task LoadType()
    {
        if (Id > 0)
        {
            Types = await _ICategory.GetCategoryAsync(Id);

        }
    }

    private async Task UpsertType()
    {
        TypeExistErrorMessage = string.Empty;
        isTypeExist = false;
        bool flag = false;
        isTypeExist = await _ICategory.CheckIfCategoryExist(Types.CategoryName, Types.CID);
        if (isTypeExist)
        {
            TypeExistErrorMessage = "Category Type Is Exist !";
            isProcessing = false;
            return;
        }
        isProcessing = true;
        if (Types.CID == 0)
        {
            var type = await _ICategory.CreateCategoryAsync(Types);
            await LogService.CreateSystemLogAsync($"Create New Category With Id: {type.CID} In the System", "CATEGORY");

            JS?.ToastrSuccess("Category Type Created Successfully");
            flag = true;
        }
        else
        {
            await _ICategory.UpdateCategoryAsync(Types);
            JS?.ToastrSuccess("Category Type Updated Created Successfully");
            flag = true;
        }
        isProcessing = false;
        _navigationManager.NavigateTo("Categories");
        if (!flag)
        {
            JS?.ToastrError("Something Get Wrong Please Try Again !!");
        }
    }
}


